---
title: "Efeito Escola SAEB 34EM"
author: "Livia Kobayashi"
date: "29/04/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(ranger)
```

** Fonte de dados **
https://www.gov.br/inep/pt-br/acesso-a-informacao/dados-abertos/microdados/saeb

```{r}
# Import 34EM
url <- "data/microdados_saeb_2019/DADOS/TS_ALUNO_34EM.csv"
#saeb_34EM <- read.csv(url, na =c("NULL","*",".",""))
saeb_34EM <- read.csv(url)
saeb_34EM <- saeb_34EM %>% filter(ID_UF == 35)
```

# Microdados Saeb 34EM 2019

Qtd.Escolas
```{r}
saeb_34EM %>% 
  distinct(ID_ESCOLA, ID_DEPENDENCIA_ADM) %>% 
  group_by(ID_DEPENDENCIA_ADM) %>% 
  count()
```

Qtd.alunos
```{r}
saeb_34EM %>% 
  group_by(ID_DEPENDENCIA_ADM) %>% 
  count()
```
```{r include=FALSE}
colnames(saeb_34EM)
```

1) Filtros:
- Escolas estaduais
- Alunos que preencheram o questionário
- Alunos cujas informações foram validadas com o Censo
- Alunos que possuem nota de LP ou MT

2) Exclui colunas

```{r}
data <- saeb_34EM %>% 
  filter(ID_DEPENDENCIA_ADM == 2, #estaduais
         IN_PREENCHIMENTO_QUESTIONARIO == 1,
         IN_SITUACAO_CENSO == 1,
         (!is.na(PROFICIENCIA_LP_SAEB) | !is.na(PROFICIENCIA_MT_SAEB))
) %>% 
  select(-ID_SAEB,
         -ID_REGIAO,
         -ID_UF,
         -ID_AREA,
         #-ID_SERIE,
         -ID_DEPENDENCIA_ADM,
         -IN_SITUACAO_CENSO,
         -IN_PREENCHIMENTO_LP,
         -IN_PREENCHIMENTO_MT,
         -IN_PRESENCA_LP,
         -IN_PRESENCA_MT,
         -ID_CADERNO_LP,
         -ID_BLOCO_1_LP,
         -ID_BLOCO_2_LP,
         -ID_CADERNO_MT,
         -ID_BLOCO_1_MT,
         -ID_BLOCO_2_MT,
         -TX_RESP_BLOCO1_LP,
         -TX_RESP_BLOCO2_LP,
         -TX_RESP_BLOCO1_MT,
         -TX_RESP_BLOCO2_MT,
         -IN_PROFICIENCIA_LP,
         -IN_PROFICIENCIA_MT,
         -PROFICIENCIA_LP,
         -PROFICIENCIA_MT,
         -ERRO_PADRAO_LP,
         -ERRO_PADRAO_MT,
         -ERRO_PADRAO_LP_SAEB,
         -ERRO_PADRAO_MT_SAEB,
         -IN_PREENCHIMENTO_QUESTIONARIO

) %>% 
  mutate(PROFICIENCIA_MEDIA = (PROFICIENCIA_LP_SAEB + PROFICIENCIA_MT_SAEB)/2)

head(data)

```
```{r}
data <- data %>% 
  mutate(ID_LOCALIZACAO = factor(ID_LOCALIZACAO, labels = c("Urbana", "Rural")),
         ID_TURNO = factor(ID_TURNO, labels = c("Matutino", "Vespertino", "Noturno")),
         ID_SERIE = factor(ID_SERIE, labels = c("Tradicional", "Integrado"))
         ) %>% 
  mutate_if(is.character, as.factor)
```

# Análise Exploratória

## Summary Nota LP
```{r}
summary(data$PROFICIENCIA_LP_SAEB)
```
```{r}
ggplot(data, aes(PROFICIENCIA_LP_SAEB)) +
  geom_histogram()
```

## Summary Nota MT
```{r}
summary(data$PROFICIENCIA_MT_SAEB)
```
```{r}
ggplot(data, aes(PROFICIENCIA_MT_SAEB)) +
  geom_histogram()
```


## Nota média por localização
```{r}
ggplot(data, aes(ID_LOCALIZACAO, PROFICIENCIA_MEDIA)) +
  geom_boxplot()
```
## Nota média por turno
```{r}
ggplot(data, aes(ID_TURNO, PROFICIENCIA_MEDIA)) +
  geom_boxplot()
```
## Nota média por tipo de ensino
```{r}
data %>% group_by(ID_SERIE) %>% 
  summarise(qtd = n(),
            nota_media = mean(PROFICIENCIA_MEDIA))
```

```{r}
ggplot(data, aes(ID_SERIE, PROFICIENCIA_MEDIA)) +
  geom_boxplot()
```



# Modelo baseline LP
```{r echo=FALSE}
df <- data %>% 
  filter(!is.na(PROFICIENCIA_LP_SAEB)) %>% 
  select(PROFICIENCIA_LP_SAEB,
         starts_with("TX_RESP_Q"))

model_lp <- ranger(data = df,
                   PROFICIENCIA_LP_SAEB ~ .)

model_lp$r.squared 
```

# Modelo baseline MT
```{r echo=FALSE}
df <- data %>% 
  filter(!is.na(PROFICIENCIA_MT_SAEB)) %>% 
  select(PROFICIENCIA_MT_SAEB,
         starts_with("TX_RESP_Q"))

model_mt <- ranger(data = df,
                   PROFICIENCIA_MT_SAEB ~ .)

model_mt$r.squared 
```

# Modelo baseline Média
```{r echo=FALSE}
df <- data %>% 
  filter(!is.na(PROFICIENCIA_MEDIA)) %>% 
  select(PROFICIENCIA_MEDIA,
         starts_with("TX_RESP_Q"))

model_mt <- ranger(data = df,
                   PROFICIENCIA_MEDIA ~ .)

model_mt$r.squared 
```

# Regressão univariada LP
```{r}
vars <- colnames(df)
vars <- vars[2:length(vars)]
vars
```

```{r}
y_resp <- "PROFICIENCIA_LP_SAEB"

tb_r2_34EM <- data.frame(var = vars)

rsquared <- c()
for (variable in vars) {
  
  lm_formula <- as.formula(str_glue("{y_resp} ~ {variable}"))
  model_lm <- lm(lm_formula, data)
  rsquared <- append(rsquared, summary(model_lm)$r.squared)
}


tb_r2_34EM$LP <- rsquared

tb_r2_34EM %>% arrange(desc(LP)) %>% head()
```

```{r}
y_resp <- "PROFICIENCIA_MT_SAEB"

rsquared <- c()
for (variable in vars) {
  
  lm_formula <- as.formula(str_glue("{y_resp} ~ {variable}"))
  model_lm <- lm(lm_formula, data)
  rsquared <- append(rsquared, summary(model_lm)$r.squared)
}


tb_r2_34EM$MT <- rsquared

tb_r2_34EM %>% arrange(desc(MT)) %>% head()
```
```{r}
y_resp <- "PROFICIENCIA_MEDIA"

rsquared <- c()
for (variable in vars) {
  
  lm_formula <- as.formula(str_glue("{y_resp} ~ {variable}"))
  model_lm <- lm(lm_formula, data)
  rsquared <- append(rsquared, summary(model_lm)$r.squared)
}


tb_r2_34EM$media <- rsquared

tb_r2_34EM %>% arrange(desc(media)) %>% head()
```
```{r}
library(readxl)
library(writexl)
label <- read_xlsx("data/microdados_saeb_2019/DADOS/label_questoes_saeb_2019.xlsx", sheet = "34EM")
```

```{r}
tb_r2_34EM <- tb_r2_34EM %>% left_join(label, by = c("var" = "questao"))
```

## Variáveis mais importantes LP
```{r}
tb_r2_34EM %>% arrange(desc(LP)) %>%  head() %>%  select(label)
```
## Variáveis mais importantes MT
```{r}
tb_r2_34EM %>% arrange(desc(MT)) %>%  head() %>%  select(label)
```
## Variáveis mais importantes Média
```{r}
tb_r2_34EM %>% arrange(desc(media)) %>%  head() %>%  select(label)
```

```{r}
write_xlsx(tb_r2_34EM, "output/analise_univariada_saeb_34EM.xlsx") 
```

